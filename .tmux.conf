############################# TMUX CONFIGURATION ###############################
##																			  ##
##			eggbean - December 2019											  ##
##																			  ##
##	 To Do: Adjust colours to more subtle pastels							  ##
##			Use push/pop-defaults to simplify nested config					  ##
##			Style additional 3 flags										  ##
##																			  ##
################################################################################

# Keep ssh-agent working on reconnection by using symlink (requires ~/.ssh/rc)
set -g update-environment "DBUS_SESSION_BUS_ADDRESS DESKTOP_SESSION DISPLAY \
	GNOME_KEYRING_CONTROL GNOME_KEYRING_PID GPG_AGENT_INFO GPG_AGENT_INFO \
	ORIGCOLORTERM ORIGTERM SESSION_MANAGER SSH_AGENT_PID SSH_CONNECTION \
	WINDOWID XAUTHORITY XDG_SESSION_COOKIE XDG_SESSION_PATH" # removes SSH_AUTH_SOCK
set-environment -g SSH_AUTH_SOCK $HOME/.ssh/ssh_auth_sock

# Find and set tmux version
run-shell 'tmux setenv -g TMUX_VERSION $(tmux -V | \
	sed -En "s/^tmux ([0-9]+(.[0-9]+)?).*/\1/p")'

# UTF-8 is autodetected in 2.2 onwards, but errors if explicitly set
if-shell -b '[ "$(echo "$TMUX_VERSION < 2.2" | bc)" = 1 ]' \
	"set -g utf8 on; set -g status-utf8 on; set -g mouse-utf8 on"

# Resize ?? 3.0a
if-shell -b '[ "$(echo "$TMUX_VERSION > 3.0a" | bc)" = 1 ]' \
	"set -g window-size latest (!)"

# Useful when using "grouped sessions" and multi-monitor setup
if-shell -b '[ "$(echo "$TMUX_VERSION < 3.0a" | bc)" = 1 ]' \
	"set -g aggressive-resize on"

# Upgrade $TERM for 256 colours
if-shell -b '[ "$(echo "$TERM)" = "xterm-256color" ]' " \
	set -s default-terminal 'xterm-256color' \
	set -s terminal-overrides ',xterm*:Tc'"

# Upgrade $TERM for 24-bit truecolour
if-shell -b '[ "$(echo "$TERM)" = "xterm-24bit" ]' " \
	set -s default-terminal 'xterm-24bit' \
	set -s terminal-overrides ',xterm-24bit:Tc'"

# Focus events enabled for terminals that support them
set -s focus-events on

# Pass xterm-style keys to make many key combinations work as expected
set -g xterm-keys on

# Mouse on
set -g mouse on

# Increase scrollback buffer size
set -g history-limit 10000

# Tmux messages are displayed for 2.5 seconds
set -g display-time 2500

# Set terminal title (remove session and window numbers prefix)
set -g set-titles on
set -g set-titles-string "#W - \"#T\""

# Renaming windows
set -g allow-rename on
set -g automatic-rename on

# Number windows starting with 1 rather than 0
set -g base-index 1

# Automatically renumber windows
set -g renumber-windows on

# Refresh 'status-left' and 'status-right' more often
set -g status-interval 5

# Alerts
set -g monitor-bell on
set -g bell-action any
set -g visual-bell off
set -g monitor-activity off
set -g visual-activity on
set -g monitor-silence 0
set -g visual-silence on

## KEY BINDINGS ----------------------------------------------------------------

# Change prefix key from C-b to C-\ (backslash)
unbind C-b
set -g prefix "C-\\"

# Prefix twice for last window
bind "C-\\" last-window

# Resume automatic window naming after manual renaming
bind 'M-<' set -u automatic-rename

# 0 selects window 10, not 0
bind 0 select-window -t :=10

# Additional window number bindings
bind M-1 select-window -t :=11
bind M-2 select-window -t :=12
bind M-3 select-window -t :=13
bind M-4 select-window -t :=14
bind M-5 select-window -t :=15
bind M-6 select-window -t :=16
bind M-7 select-window -t :=17
bind M-8 select-window -t :=18
bind M-9 select-window -t :=19
bind M-0 select-window -t :=20

# R reloads tmux configuration
bind R source-file ~/.tmux.conf \; \
	display-message "source-file done"

# Do not start with current name when renaming window
bind , command-prompt "rename-window '%%'"

# Join pane
bind @ choose-window 'join-pane -h -s "%%"'

# Synchronise panes
bind * set synchronize-panes \; \
	display-message "synchronise-panes is now #{?pane_synchronized,on,off}"
# You can stop synchronize-panes affecting a pane by disabling
#	it with selectp -d (enable it again with selectp -e)

# Kill session
bind X kill-session

## COLOURS ---------------------------------------------------------------------

if-shell -b '[ "$(echo "$TERM)" = "xterm-24bit" ]' " \
	TMUX_COLOUR_ZOOMED=#5b7ce5 \
	TMUX_COLOUR_ACTIVE=#4169e1 \
	TMUX_COLOUR_INACTIVE=#132c76 \
	TMUX_COLOUR_BELL=#fa8072 \
	TMUX_COLOUR_MARKED=#69e141 \
	TMUX_COLOUR_MESSAGE=#dc143c \
	TMUX_COLOUR_WHITE=colour225 \
	TMUX_COLOUR_BLACK=colour16"

if-shell -b '[ "$(echo "$TERM)" = "xterm-256color" ]' " \
	TMUX_COLOUR_ZOOMED=colour32 \
	TMUX_COLOUR_ACTIVE=colour26 \
	TMUX_COLOUR_INACTIVE=colour19 \
	TMUX_COLOUR_BELL=colour211 \
	TMUX_COLOUR_MARKED=colour48 \
	TMUX_COLOUR_MESSAGE=colour196 \
	TMUX_COLOUR_WHITE=colour225 \
	TMUX_COLOUR_BLACK=colour16"

## STATUSBAR -------------------------------------------------------------------

# Statusbar styling
set -g status-style "fg=$TMUX_COLOUR_BLACK,bg=$TMUX_COLOUR_ACTIVE"
set -g window-status-current-style "fg=$TMUX_COLOUR_WHITE,bg=$TMUX_COLOUR_ACTIVE"
set -g window-status-format "#{?window_zoomed_flag,#[bg=$TMUX_COLOUR_ZOOMED],}#{?window_bell_flag,#[fg=$TMUX_COLOUR_BELL#,bg=$TMUX_COLOUR_BLACK],} #I:#W "
set -g window-status-current-format "#{?window_zoomed_flag,#[bg=$TMUX_COLOUR_ZOOMED],}#{?window_bell_flag,#[fg=$TMUX_COLOUR_BELL#,bg=$TMUX_COLOUR_BLACK],} #I:#W "

# Additional flags: window_silence_flag window_activity_flag windows_marked_flag

# Message background colour
set -g message-style "fg=$TMUX_COLOUR_MESSAGE"

# Set hostname on right end of status bar
set -g status-right "#[fg=$TMUX_COLOUR_WHITE]#(hostname -f) "

## NESTED TMUX -----------------------------------------------------------------

bind -n C-t new-window -a
bind -n C-PPage	prev
bind -n C-NPage next
bind -n C-S-PPage swap-window -t -1
bind -n C-S-NPage swap-window -t +1

bind -n M-F11 \
	set -qg status-right "#[fg=$TMUX_COLOUR_BLACK]#(hostname -f) " \; \
	set -qg status-style "fg=$TMUX_COLOUR_BLACK,bg=$TMUX_COLOUR_INACTIVE" \; \
	set -qg window-status-format "#{?window_zoomed_flag,#[bg=$TMUX_COLOUR_INACTIVE],}#{?window_bell_flag,#[fg=$TMUX_COLOUR_BELL#,bg=$TMUX_COLOUR_BLACK],} #I:#W "
bind -n M-F12 \
	set -qg status-right "#[fg=$TMUX_COLOUR_WHITE]#(hostname -f) " \; \
	set -qg status-style "fg=$TMUX_COLOUR_BLACK,bg=$TMUX_COLOUR_ACTIVE" \; \
	set -qg window-status-format "#{?window_zoomed_flag,#[bg=$TMUX_COLOUR_ZOOMED],}#{?window_bell_flag,#[fg=$TMUX_COLOUR_BELL#,bg=$TMUX_COLOUR_BLACK],} #I:#W "
bind -n C-M-PPage \
	send-keys M-F12 \; \
	set -qg status-right "#[fg=$TMUX_COLOUR_BLACK]#(hostname -f) " \; \
	set -qg status-style "fg=$TMUX_COLOUR_BLACK,bg=$TMUX_COLOUR_INACTIVE" \; \
	set -qg window-status-current-style "fg=$TMUX_COLOUR_WHITE,bg=$TMUX_COLOUR_ACTIVE" \; \
	set -qg window-status-format "#{?window_zoomed_flag,#[bg=$TMUX_COLOUR_INACTIVE],}#{?window_bell_flag,#[fg=$TMUX_COLOUR_BELL#,bg=$TMUX_COLOUR_BLACK],} #I:#W " \; \
	set -qg window-status-current-format "#{?window_zoomed_flag,#[bg=$TMUX_COLOUR_ZOOMED],}#{?window_bell_flag,#[fg=$TMUX_COLOUR_BELL#,bg=$TMUX_COLOUR_BLACK],} #I:#W " \; \
	unbind -n C-PPage \; \
	unbind -n C-NPage \; \
	unbind -n C-S-PPage \; \
	unbind -n C-S-NPage \; \
	unbind -n C-t \; \
	set -qg prefix C-b
bind -n C-M-NPage \
	send-keys M-F11 \; \
	set -qg status-right "#[fg=$TMUX_COLOUR_WHITE]#(hostname -f) " \; \
	set -qg status-style "fg=$TMUX_COLOUR_BLACK,bg=$TMUX_COLOUR_ACTIVE" \; \
	set -qg window-status-current-style "fg=$TMUX_COLOUR_WHITE,bg=$TMUX_COLOUR_ACTIVE" \; \
	set -qg window-status-format "#{?window_zoomed_flag,#[bg=$TMUX_COLOUR_ZOOMED],}#{?window_bell_flag,#[fg=$TMUX_COLOUR_BELL#,bg=$TMUX_COLOUR_BLACK],} #I:#W " \; \
	set -qg window-status-current-format "#{?window_zoomed_flag,#[bg=$TMUX_COLOUR_ZOOMED],}#{?window_bell_flag,#[fg=$TMUX_COLOUR_BELL#,bg=$TMUX_COLOUR_BLACK],} #I:#W " \; \
	bind -n C-PPage	prev \; \
	bind -n C-NPage next \; \
	bind -n C-S-PPage swap-window -t -1 \; \
	bind -n C-S-NPage swap-window -t +1 \; \
	bind -n C-t new-window -a -c "#{pane_current_path}" \; \
	set -qg prefix "C-\\"

## PLUGINS ---------------------------------------------------------------------

if "test ! -d ~/.tmux/plugins/tpm" \
	"run 'git clone https://github.com/tmux-plugins/tpm ~/.tmux/plugins/tpm'"

set -g @plugin 'tmux-plugins/tpm'
set -g @plugin 'tmux-plugins/tmux-pain-control'
set -g @plugin 'tmux-plugins/tmux-sidebar'
set -g @sidebar-tree-command 'tree -C'
set -g @plugin 'nhdaly/tmux-better-mouse-mode'
set -g @scroll-without-changing-pane 'on'
set -g @emulate-scroll-for-no-mouse-alternate-buffer 'on'

# Initialise TMUX plugin manager (keep this line at the very bottom of tmux.conf)
run -b '~/.tmux/plugins/tpm/tpm'
