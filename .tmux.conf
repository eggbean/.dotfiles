############################# TMUX CONFIGURATION ###############################
##																			  ##
##			eggbean - December 2019											  ##
##																			  ##
##	 To Do: Use push/pop-defaults to simplify nested config	theming			  ##
##			Change stying to new format for v3.0 >							  ##
##																			  ##
################################################################################

# Keep ssh-agent working on reconnection by using symlink (requires ~/.ssh/rc)
set -g update-environment "DBUS_SESSION_BUS_ADDRESS DESKTOP_SESSION DISPLAY \
	GNOME_KEYRING_CONTROL GNOME_KEYRING_PID GPG_AGENT_INFO GPG_AGENT_INFO \
	ORIGCOLORTERM ORIGTERM SESSION_MANAGER SSH_AGENT_PID SSH_CONNECTION \
	WINDOWID XAUTHORITY XDG_SESSION_COOKIE XDG_SESSION_PATH" # removes SSH_AUTH_SOCK
set-environment -g SSH_AUTH_SOCK $HOME/.ssh/ssh_auth_sock

# Find and set tmux version
run-shell 'tmux setenv -g TMUX_VERSION $(tmux -V | \
	sed -En "s/^tmux ([0-9]+(.[0-9]+)?).*/\1/p")'

# Useful when using "grouped sessions" and multi-monitor setup
if-shell -b '[ "$(echo "$TMUX_VERSION < 3.0a" | bc)" = 1 ]' \
	"set -g aggressive-resize on"

# Resize window > 3.0a
if-shell -b '[ "$(echo "$TMUX_VERSION > 3.0a" | bc)" = 1 ]' \
	"set -g window-size latest (!)"

# Upgrade $TERM for 256 colours
if-shell -F "#{==:$TERM,xterm-256color}" " \
	set -s default-terminal 'xterm-256color'; \
	set -s terminal-overrides ',xterm*:Tc'"

# Upgrade $TERM for 24-bit truecolour
if-shell -F "#{==:$TERM,xterm-24bit}" " \
	set -s default-terminal 'xterm-24bit'; \
	set -s terminal-overrides ',xterm-24bit:Tc'"

# Focus events enabled for terminals that support them
set -s focus-events on

# Status line enabled (override default off setting in google cloud shell)
set -g status on
set -g status-position bottom

# Pass xterm-style keys to make many key combinations work as expected
set -g xterm-keys on

# Copy-mode keys
set -g mode-keys emacs

# Mouse on
set -g mouse on

# Increase scrollback buffer size
set -g history-limit 10000

# Tmux messages are displayed for 2.5 seconds
set -g display-time 2500

# Set terminal title (remove session and window numbers prefix)
set -g set-titles on
set -g set-titles-string "#W - \"#T\""

# Renaming windows
set -g allow-rename on
set -g automatic-rename on

# Number windows starting with 1 rather than 0
set -g base-index 1

# Automatically renumber windows
set -g renumber-windows on

# Refresh 'status-left' and 'status-right' more often
set -g status-interval 5

# Alerts
set -g monitor-bell on
set -g bell-action any
set -g visual-bell off
set -g monitor-activity off
set -g activity-action other
set -g visual-activity on
set -g monitor-silence 0
set -g silence-action other
set -g visual-silence on

## COLOURS ---------------------------------------------------------------------

set -g @zoomed 'colour68'
set -g @active 'colour27'
set -g @inactive 'colour18'
set -g @message 'colour197'
set -g @bell 'colour210'
set -g @marked 'colour76'
set -g @white 'colour225'
set -g @black 'colour16'

# if-shell -F "#{==:$TERM,xterm-256color}" " \
# 	set -gq @zoomed 'colour68'; \
# 	set -gq @active 'colour27'; \
# 	set -gq @inactive 'colour18'; \
# 	set -gq @message 'colour197'; \
# 	set -gq @bell 'colour210'; \
# 	set -gq @marked 'colour76'; \
# 	set -gq @white 'colour225'; \
# 	set -gq @black 'colour16'"
# 
# if-shell -F "#{==:$TERM,xterm-24bit}" " \
# 	set -gq @zoomed '#5b7ce5'; \
# 	set -gq @active '#4169e1'; \
# 	set -gq @inactive '#132c76'; \
# 	set -gq @message '#dc143c'; \
# 	set -gq @bell '#fa8072'; \
# 	set -gq @marked '#69e141'; \
# 	set -gq @white 'colour225'; \
# 	set -gq @black 'colour16'"

# Border colours
set -g pane-active-border-style "fg=green,bg=default"
set -g pane-border-style "fg=magenta,bg=default"

## KEY BINDINGS ----------------------------------------------------------------

# Change prefix key from C-b to C-\ (backslash)
unbind C-b
set -g prefix "C-\\"

# Prefix twice for last window
bind "C-\\" last-window

# New window
bind -n C-M-t new-window -a

# Window navigation
bind -n C-PPage	prev
bind -n C-NPage next
bind -n C-S-PPage swap-window -t -1
bind -n C-S-NPage swap-window -t +1

# 0 selects window 10, not 0
bind 0 select-window -t :=10

# Additional window number bindings
bind M-1 select-window -t :=11
bind M-2 select-window -t :=12
bind M-3 select-window -t :=13
bind M-4 select-window -t :=14
bind M-5 select-window -t :=15
bind M-6 select-window -t :=16
bind M-7 select-window -t :=17
bind M-8 select-window -t :=18
bind M-9 select-window -t :=19
bind M-0 select-window -t :=20

# Resume automatic window naming after manual renaming
bind "M-<" set -u automatic-rename

# Do not start with current name when renaming window
bind , command-prompt 'rename-window -- "%%"'

# Pane navigation
bind -n C-M-Up	  select-pane -U
bind -n C-M-Down  select-pane -D
bind -n C-M-Left  select-pane -L
bind -n C-M-Right select-pane -R

# Pane splitting
bind "|"  split-window -h -c "#{pane_current_path}"
bind "\\" split-window -fh -c "#{pane_current_path}"
bind "-"  split-window -v -c "#{pane_current_path}"
bind "_"  split-window -fv -c "#{pane_current_path}"

# Join pane
bind @ choose-window 'join-pane -h -s "%%"'

# Synchronise panes
bind * set synchronize-panes
# You can stop synchronize-panes affecting a pane by disabling
#	it with selectp -d (enable it again with selectp -e)

# M-PgUp/PgDn for half page up/down in copy-mode
bind -T copy-mode M-NPage send-keys -X halfpage-down
bind -T copy-mode M-PPage send-keys -X halfpage-up

# Copy in copy-mode, without exiting
bind -T copy-mode M-y send-keys -X copy-selection

# Copy-mode arrow key C-Left/Right navigation
bind -T copy-mode C-Left  send-keys -X previous-word
bind -T copy-mode C-Right send-keys -X next-word-end

# R reloads tmux configuration
bind R source-file ~/.tmux.conf \; \
	display-message "source-file done"

# Create new session
bind C command-prompt 'new-session -s "%%"'

# Kill session
bind X kill-session

## NESTED TMUX -----------------------------------------------------------------

bind -n M-F11 \
	set -g status-right "#[fg=#{@black}]#(hostname -f) " \; \
	set -Fga status-style "bg=#{@inactive}" \; \
	set -g window-status-format "#{?window_zoomed_flag,#[bg=#{@inactive}],}#{?window_bell_flag,#[fg=#{@bell}#,bg=#{@black}],} #I:#W#{?pane_synchronized,*,} "
bind -n M-F12 \
	set -g status-right "#[fg=#{@white}]#(hostname -f) " \; \
	set -Fga status-style "bg=#{@active}" \; \
	set -g window-status-format "#{?window_zoomed_flag,#[bg=#{@zoomed}],}#{?window_bell_flag,#[fg=#{@bell}#,bg=#{@black}],} #I:#W#{?pane_synchronized,*,} "
bind -n C-M-PPage \
	send-keys M-F12 \; \
	set -g status-right "#[fg=#{@black}]#(hostname -f) " \; \
	set -Fga status-style "bg=#{@inactive}" \; \
	set -g window-status-format "#{?window_zoomed_flag,#[bg=#{@inactive}],}#{?window_bell_flag,#[fg=#{@bell}#,bg=#{@black}],} #I:#W#{?pane_synchronized,*,} " \; \
	unbind -n C-PPage \; \
	unbind -n C-NPage \; \
	unbind -n C-S-PPage \; \
	unbind -n C-S-NPage \; \
	unbind -n C-M-t \; \
	set -g prefix C-b
bind -n C-M-NPage \
	send-keys M-F11 \; \
	set -g status-right "#[fg=#{@white}]#(hostname -f) " \; \
	set -Fga status-style "bg=#{@active}" \; \
	set -g window-status-format "#{?window_zoomed_flag,#[bg=#{@zoomed}],}#{?window_bell_flag,#[fg=#{@bell}#,bg=#{@black}],} #I:#W#{?pane_synchronized,*,} " \; \
	bind -n C-PPage	prev \; \
	bind -n C-NPage next \; \
	bind -n C-S-PPage swap-window -t -1 \; \
	bind -n C-S-NPage swap-window -t +1 \; \
	bind -n C-M-t new-window -a -c "#{pane_current_path}" \; \
	set -g prefix "C-\\"

## STATUS LINE -----------------------------------------------------------------

# Status line styling
set -Fg status-style "fg=#{@black},bg=#{@active}"
set -Fg window-status-current-style "fg=#{@white},bg=#{@active}"
set -g window-status-format "#{?window_zoomed_flag,#[bg=#{@zoomed}],}#{?window_bell_flag,#[fg=#{@bell}#,bg=#{@black}],} #I:#W#{?pane_synchronized,*,} "
set -g window-status-current-format "#{?window_zoomed_flag,#[bg=#{@zoomed}],}#{?window_bell_flag,#[fg=#{@bell}#,bg=#{@black}],} #I:#W#{?pane_synchronized,*,} "

# Additional flags: window_silence_flag window_activity_flag windows_marked_flag

# Message background colour
set -Fg message-style "fg=#{@message}"

# set hostname on right end of status bar
set -g status-right "#[fg=#{@white}]#(hostname -f) "

## PLUGINS ---------------------------------------------------------------------

if "test ! -d ~/.tmux/plugins/tpm" \
	"run 'git clone https://github.com/tmux-plugins/tpm ~/.tmux/plugins/tpm'"

set -g @plugin 'tmux-plugins/tpm'
set -g @plugin 'tmux-plugins/tmux-sidebar'
set -g @sidebar-tree-command 'tree -C'
set -g @plugin 'nhdaly/tmux-better-mouse-mode'
set -g @scroll-without-changing-pane 'on'
set -g @emulate-scroll-for-no-mouse-alternate-buffer 'on'

# Initialise TMUX plugin manager (keep this line at the very bottom of tmux.conf)
run -b '~/.tmux/plugins/tpm/tpm'
