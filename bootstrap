# This script should be sourced, not executed
# vim: filetype=bash

redc=$(tput setaf 1)
gren=$(tput setaf 2)
yelw=$(tput setaf 3)
bold=$(tput bold)
norm=$(tput sgr0)

if ! command -v gum >/dev/null; then
  alias gum="~/.dotfiles/bin/$(arch)/gum"
fi

# Update packages
eval "$(. /etc/os-release && typeset -p ID)"
if [[ $ID =~ ^(fedora|amzn|ol)$ ]]; then
  [[ $ID == ol ]] && repo=ol9_developer_EPEL
  sudo dnf config-manager --set-enabled $repo
  sudo dnf upgrade -y || \
    { echo "${redc}Failed: packages update${norm}" >&2; return 1; }
elif [[ $ID =~ ^(debian|ubuntu)$ ]]; then
  gum spin --title "Updating package information from sources" -- \
    sudo apt-get update -qq && sudo apt-get upgrade -y || \
    { echo "${redc}Failed: packages update${norm}" >&2; return 1; }
fi

# Pull dotfiles origin/master
git -C ~/.dotfiles remote update
[[ $(git -C ~/.dotfiles rev-parse HEAD) == \
  $(git -C ~/.dotfiles ls-remote $(git -C ~/.dotfiles rev-parse --abbrev-ref @{u} | \
  sed 's/\// /g') | cut -f1) ]] && echo Local repository is up to date || \
  echo Local repository has diverged from remote. Updating now.. && {
    git -C ~/.dotfiles diff-index --quiet HEAD || stash=true
    [[ $stash ]] && git -C ~/.dotfiles stash push --quiet
    git -C ~/.dotfiles pull --no-ff
    [[ $stash ]] && git -C ~/.dotfiles stash pop --quiet
    unset stash
  }

# Install/uninstall some native packages
[[ $ID =~ ^(fedora|amzn|ol)$ ]] && pkmngcmd='dnf'
[[ $ID =~ ^(debian|ubuntu)$ ]] && pkmngcmd='apt-get'
if [[ $pkmngcmd ]]; then
  if ! cmp --silent ~/.dotfiles/packages $XDG_STATE_HOME/bootstrap_packages; then
    source ~/.dotfiles/packages; sudo $pkmngcmd install -y -- "${packages[@]}" || \
      { echo "${redc}Failed: package installation${norm}" >&2; return 1; }
    current=("${packages[@]}") && unset packages
    if [[ -e $XDG_STATE_HOME/bootstrap_packages ]]; then
      source $XDG_STATE_HOME/bootstrap_packages
      for i in "${current[@]}"; do packages=(${packages[@]//*$i*}); done
      sudo $pkmngcmd remove -y -- "${packages[@]}" || \
        { echo "${redc}Failed: package removal${norm}" >&2; return 1; }
    fi
    command cp ~/.dotfiles/packages $XDG_STATE_HOME/bootstrap_packages
    unset packages current
  fi
  unset pkmngcmd
fi

# Install/update nix package manager
# and install/uninstall packages
if ! command -v nix  >/dev/null; then
  git -C ~/.dotfiles diff-index --quiet HEAD || stash=true
  [[ $stash ]] && git -C ~/.dotfiles stash push --quiet
  { gum spin --title "Installing nix package manager" -- \
    sh <(curl -sL https://nixos.org/nix/install) --no-daemon && \
    echo nix package manager installed; } && \
    . /home/jason/.nix-profile/etc/profile.d/nix.sh || \
    { echo "${redc}Failed: nix package manager installation${norm}" >&2; return 1; }
  git -C ~/.dotfiles/config checkout .zshenv .bash_profile --quiet
  [[ $stash ]] && git -C ~/.dotfiles stash pop --quiet
  unset stash
fi
nix-channel --update
if ! cmp --silent ~/.dotfiles/nix.pkgs $XDG_STATE_HOME/nix_packages; then
  installpkgs=("${(f)$(comm -2 -3 <(sort -u ~/.dotfiles/nix.pkgs) \
    <(sort -u $XDG_STATE_HOME/nix_packages 2>/dev/null))}")
  for nixpkg in ${installpkgs[@]}; do
    nix-env -iA $nixpkg && \
      echo "${gren}${nixpkg#nixpkgs.} installed${norm}" || \
      { echo "${redc}Failed: ${nixpkg#nixpkgs.} nix package installation${norm}" >&2
        return 1; }
  done
  removepkgs=("${(f)$(comm -1 -3 <(sort -u ~/.dotfiles/nix.pkgs) \
    <(sort -u $XDG_STATE_HOME/nix_packages 2>/dev/null))}")
  for rmnixpkg in ${removepkgs[@]}; do
    nix-env --uninstall ${rmnixpkg#nixpkgs.} && \
      echo "${yelw}${rmnixpkg#nixpkgs.} uninstalled${norm}" || \
      { echo "${redc}Failed: ${rmnixpkg#nixpkgs.} nix package removal${norm}" >&2
        return 1; }
  done
  unset installpkgs removepkgs
  command cp ~/.dotfiles/nix.pkgs $XDG_STATE_HOME/nix_packages
fi

# Setup/update antidote
if [[ $ZSH_VERSION ]]; then
  if [[ ! -d ~/.cache/antidote ]]; then
    git clone --depth=1 https://github.com/mattmc3/antidote.git ~/.cache/antidote
  fi
  source ~/.cache/antidote/antidote.zsh
  antidote load ~/.dotfiles/config/.includes/zsh_plugins.txt
  antidote update | grep -Ev "(^antidote: checking for updates|^$)"
fi

# Stow binaries
if [[ $UID -ne 0 ]] && [[ $EUID -ne 0 ]]; then
  gum spin --title "Stowing binaries" -- \
    sudo ~/.dotfiles/bin/scripts/stow-bin.sh && \
    echo "Binaries stowed" || \
    { echo "${redc}Failed: stow-bin.sh${norm}" >&2; return 1; }
else
  gum spin --title "Stowing binaries" -- \
    ~/.dotfiles/bin/scripts/stow-bin.sh --nosudo && \
    echo "Binaries stowed" || \
    { echo "${redc}Failed: stow-bin.sh${norm}" >&2; return 1; }
fi

# Stow dotfiles
gum spin --title "Stowing dotfiles" -- \
  ~/.dotfiles/bin/scripts/stow-dotfiles.sh && \
  echo "Dotfiles stowed" || \
  { echo "${redc}Failed: stow-dotfiles.sh${norm}" >&2; return 1; }

# Check for new kernel
if ! grep -qi microsoft /proc/version; then
  ~/.dotfiles/bin/scripts/kernel-update-check.sh
fi

# Initialise shell
exec $SHELL
